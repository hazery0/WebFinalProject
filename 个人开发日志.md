# 个人开发日志

## 2025-12-14

### 后端开发

#### 1. 项目初始化与依赖配置
- 创建了Spring Boot 3项目
- 添加了JWT和密码加密依赖
- 配置了MySQL数据库连接

#### 2. 核心代码开发
- 创建了`User`实体类，包含id、username、password、isAdmin字段
- 实现了`UserRepository`接口，用于数据库操作
- 创建了`JwtUtil`工具类，用于生成和验证JWT令牌
- 创建了`PasswordEncoderUtil`工具类，使用BCrypt加密密码

#### 3. 控制器开发
- 实现了`AuthController`，包含：
  - 注册接口：`POST /api/auth/register`
  - 登录接口：`POST /api/auth/login`
- 配置了CORS，允许前端跨域请求

#### 4. 安全配置
- 实现了`SecurityConfig`，配置了：
  - JWT认证
  - 权限控制
  - CORS配置
  - 允许匿名访问的端点

### 前端开发

#### 1. 项目初始化
- 检查了前端项目结构
- 安装了axios依赖

#### 2. API服务封装
- 创建了`api.ts`，配置了axios实例
- 实现了请求拦截器和响应拦截器
- 封装了认证相关API

## 2025-12-15

### 后端开发

#### 1. 健康检查端点
- 添加了`HealthController`，提供`/api/health`端点
- 用于前端测试后端连接

#### 2. 配置更新
- 更新了CORS配置，将允许的源地址从5174改为5173
- 更新了安全配置，允许`/api/health`匿名访问

### 前端开发

#### 1. 清理与重构
- 清理了现有代码，保留核心文件
- 简化了`App.vue`和`main.ts`
- 配置了基础路由

#### 2. 登录注册组件
- 创建了`LoginView.vue`登录组件：
  - 用户名密码输入
  - 登录逻辑实现
  - 错误处理
  - 注册链接

- 创建了`RegisterView.vue`注册组件：
  - 用户名密码输入
  - 注册逻辑实现
  - 表单验证
  - 登录链接

#### 3. 路由配置
- 更新了路由配置，添加了登录和注册路由
- 将根路径`/`重定向到`/login`
- 保留`/home`作为登录后的首页

#### 4. API服务更新
- 添加了登录和注册请求方法
- 配置了请求拦截器，自动携带JWT令牌

## 2025-12-16

### 后端开发

#### 1. API扩展
- 添加了批量导入历史人物的API端点`POST /api/historical-persons/batch`
- 添加了更新历史人物的API端点`PUT /api/historical-persons/{id}`
- 扩展了`HistoricalPersonService`，添加了`batchAddHistoricalPersons`方法

#### 2. 数据库操作优化
- 使用JPA的`saveAll`方法实现高效批量插入
- 利用save方法的特性，根据ID判断是新增还是更新

### 前端开发

#### 1. 管理员功能
- 实现了历史人物的编辑功能，采用悬浮窗形式
- 添加了批量导入功能，支持JSON文件导入
- 实现了完整的分页功能，包括：
  - 上一页/下一页导航
  - 每页显示数量调整
  - 页码跳转
  - 记录范围显示

#### 2. 编辑悬浮窗
- 将编辑表单改为悬浮窗模态框
- 点击遮罩层或关闭按钮可关闭
- 支持键盘ESC关闭
- 表单居中显示，提升用户体验

#### 3. 分页功能
- 实现了前端分页逻辑，支持大数据量展示
- 实时更新分页状态和记录范围
- 调整每页显示数量后自动重置到第一页

#### 4. 样式优化
- 统一了表单样式
- 优化了模态框设计
- 添加了动画效果
- 响应式布局适配

### 其他工作

#### 1. 文件处理
- 尝试修复`2.json`文件的乱码问题
- 编写了编码转换脚本

#### 2. 功能测试
- 测试了编辑悬浮窗功能
- 验证了分页功能
- 测试了批量导入功能

#### 3. 代码优化
- 统一了组件命名规范
- 优化了状态管理
- 改进了错误处理

## 遇到的问题及解决方案

### 后端问题

1. **JWT工具类API更新问题**
   - 问题：JJWT 0.12.x版本API变化，导致`parseClaimsJws`方法调用失败
   - 解决方案：更新JWT工具类，使用新的API格式

2. **CORS配置问题**
   - 问题：前端端口变化，导致跨域请求失败
   - 解决方案：更新后端CORS配置，匹配前端实际端口

### 前端问题

1. **路由重定向循环**
   - 问题：登录成功后跳转到`/`，但`/`已重定向到`/login`，导致无限循环
   - 解决方案：将登录成功跳转路径改为`/home`

2. **vue-router导入错误**
   - 问题：`RouteRecordRaw`不再作为命名导出提供
   - 解决方案：移除类型导入，使用隐式类型推断

3. **浏览器扩展错误**
   - 问题：CSS Peeper扩展导致控制台报错
   - 解决方案：确认不是应用代码问题，建议更新或禁用扩展

## 项目状态

### 后端
- 核心功能已实现
- 登录注册接口正常
- 健康检查端点正常
- CORS和Security配置正确

### 前端
- 登录注册界面已实现
- 路由配置完成
- API服务已配置
- 能正常与后端通信

### 前后端联调
- 已完成基础联调
- 登录注册功能正常
- JWT令牌能正常生成和验证
- 跨域请求正常

## 后续计划

1. 完善首页功能
2. 添加更多业务功能
3. 优化用户体验
4. 添加更完善的错误处理
5. 实现用户信息管理

## 技术栈

### 后端
- Spring Boot 3
- Spring Data JPA
- MySQL
- JWT
- Spring Security
- BCrypt密码加密

### 前端
- Vue 3
- TypeScript
- Vue Router
- Axios
- Vite

## 访问地址

- 前端：http://localhost:5173
- 后端API：http://localhost:8080/api
- 登录页面：http://localhost:5173/login
- 注册页面：http://localhost:5173/register
- 首页：http://localhost:5173/home

## 2025-12-19

### 后端开发

#### 1. WebSocket CORS配置修复
- **问题**：WebSocket连接时出现CORS错误，提示`Access-Control-Allow-Origin`头为通配符`*`但请求的`credentials mode`是`include`
- **解决方案**：
  - 修改`SecurityConfig.java`，将`setAllowedOriginPatterns("*")`改为`setAllowedOrigins("http://localhost:5173", "http://localhost:5174")`
  - 修改`WebSocketConfig.java`，将`setAllowedOriginPatterns("*")`改为`setAllowedOrigins("http://localhost:5173", "http://localhost:5174")`
  - 确保前后端CORS配置一致

#### 2. 配置优化
- 移除了所有控制器上的`@CrossOrigin`注解，统一使用全局CORS配置
- 优化了WebSocket端点注册，简化了配置

### 前端开发

#### 1. WebSocket连接恢复
- **问题**：WebSocket连接失败，使用了HTTP轮询作为备选方案
- **解决方案**：
  - 恢复了完整的WebSocket连接逻辑
  - 配置SockJS实例，设置`withCredentials: false`避免CORS问题
  - 指定只使用`websocket`传输方式，减少HTTP轮询的使用
  - 保留HTTP轮询作为备选方案，提高系统容错性

#### 2. 游戏功能优化
- 恢复了通过WebSocket发送消息的游戏操作函数
- 修复了`startGame`、`leaveRoom`等函数，使用WebSocket发送消息
- 优化了WebSocket连接错误处理

#### 3. TypeScript类型修复
- **问题**：前端TypeScript类型定义与实际使用不匹配
- **解决方案**：
  - 在`api.ts`中新增`CreateHistoricalPerson`类型，用于创建历史人物时不包含id字段
  - 更新`historicalPersonApi.add`和`historicalPersonApi.batchAdd`方法，使用`CreateHistoricalPerson`类型
  - 修复`AdminView.vue`中birthYear为null的问题
  - 修复`GuessModule.vue`中的`HistoricalPerson`接口，支持number和boolean类型的属性

#### 4. 构建成功
- 解决了所有TypeScript类型错误
- 成功运行`npm run build`，前端项目构建成功

### 前后端联调

#### 1. WebSocket连接测试
- 修复了WebSocket CORS配置
- 恢复了WebSocket连接功能
- 测试了WebSocket连接状态
- 验证了实时消息推送功能

#### 2. 多人游戏功能测试
- 测试了创建房间、加入房间
- 测试了开始游戏、猜测人物
- 测试了投降功能
- 验证了实时状态更新

### 修复的问题

#### 1. WebSocket CORS错误
- **问题**：`Access-Control-Allow-Origin`头为通配符`*`但请求的`credentials mode`是`include`
- **解决方案**：使用具体的允许来源，而不是通配符

#### 2. TypeScript类型错误
- **问题**：`add`方法需要id字段，但id由后端生成
- **解决方案**：创建不包含id字段的类型`CreateHistoricalPerson`

#### 3. WebSocket连接失败
- **问题**：WebSocket无法连接，自动切换到HTTP轮询
- **解决方案**：优化WebSocket配置，禁用`withCredentials`

### 技术改进

#### 1. 系统容错性提升
- 保留了HTTP轮询作为WebSocket的备选方案
- 提高了系统在不同网络环境下的适应性

#### 2. 代码质量优化
- 统一了CORS配置
- 优化了WebSocket连接逻辑
- 修复了TypeScript类型错误
- 提高了代码的可维护性

### 后续计划

1. 继续测试WebSocket连接的稳定性
2. 优化实时消息推送机制
3. 完善多人游戏功能
4. 测试不同网络环境下的系统表现
5. 优化前端用户体验
5. 修复 TypeScript错误，后续查看如何在后端进行修改以实现功能。